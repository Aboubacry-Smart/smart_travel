<?xml version='1.0' encoding='utf-8'?>
<odoo>
    <template id="travel_booking_order" name="Travel Booking Order">
        <t t-call="website.layout">
            <div class="container mt-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h3 class="mb-3 text-success">Réservation enregistrée</h3>
                        <p class="text-muted">Vos informations de réservation ont été enregistrées avec succès. Veuillez procéder au paiement.</p>
                        
                        <div class="row mt-4">
                            <!-- Colonne Gauche: Paiement -->
                            <div class="col-md-6">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0">Effectuer le paiement</h5>
                                    </div>
                                    <div class="card-body">
                                        <form method="post" enctype="multipart/form-data" action="/my/travel/order/pay">
                                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                            <input type="hidden" name="order_ids" t-att-value="','.join([str(o.id) for o in orders])"/>
                                            
                                            <!-- Sélection méthode de paiement -->
                                            <div class="mb-3">
                                                <label for="payment_method" class="form-label">Méthode de paiement</label>
                                                <select class="form-select" id="payment_method" name="payment_method_id" required="required" onchange="showQRCode(this.value)">
                                                    <option value="">Sélectionnez une méthode</option>
                                                    <t t-foreach="payment_methods" t-as="pm">
                                                        <option t-att-value="pm.id">
                                                            <t t-esc="pm.name"/>
                                                        </option>
                                                    </t>
                                                </select>
                                            </div>
                                            
                                            <!-- QR codes cachés pour chaque méthode -->
                                            <t t-foreach="payment_methods" t-as="pm">
                                                <div t-att-id="'qr_zone_' + str(pm.id)" class="mb-3 qr-zone" style="display: none;">
                                                    <label class="form-label">QR Code de paiement</label>
                                                    <div class="text-center p-3 border rounded">
                                                        <t t-if="pm.qr_code">
                                                            <!-- Utilise la route /web/image d'Odoo pour afficher l'image -->
                                                            <img t-att-src="'/web/image/payment.method/' + str(pm.id) + '/qr_code'" 
                                                                 alt="QR Code" class="img-fluid" style="max-width: 200px;"/>
                                                        </t>
                                                        <t t-else="">
                                                            <div class="text-muted">QR Code non disponible</div>
                                                        </t>
                                                        <p class="mt-2 text-muted small">Scannez ce QR code pour effectuer le paiement</p>
                                                    </div>
                                                </div>
                                            </t>
                                            
                                            <!-- Upload preuve de paiement -->
                                            <div class="mb-3">
                                                <label for="payment_proof" class="form-label">Preuve de paiement</label>
                                                <input type="file" class="form-control" id="payment_proof" name="payment_proof" accept="image/*" required="required"/>
                                                <div class="form-text">Téléchargez une capture d'écran de votre paiement</div>
                                            </div>
                                            
                                            <!-- Bouton validation -->
                                            <div class="d-grid">
                                                <button type="submit" class="btn btn-success btn-lg">
                                                    <i class="fa fa-check"></i> Valider le paiement
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Colonne Droite: Liste des réservations -->
                            <div class="col-md-6">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0">Détails des réservations</h5>
                                    </div>
                                    <div class="card-body">
                                        <t t-if="orders">
                                            <div class="table-responsive">
                                                <table class="table table-striped table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>Place N°</th>
                                                            <th>Passager</th>
                                                            <th>Téléphone</th>
                                                            <th>Route</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr t-foreach="orders" t-as="o">
                                                            <td class="fw-bold text-primary">
                                                                <i class="fa fa-seat"></i>
                                                                <t t-esc="o.place"/>
                                                            </td>
                                                            <td><t t-esc="o.passenger_id.name"/></td>
                                                            <td><t t-esc="o.passenger_id.phone"/></td>
                                                            <td><t t-esc="o.route_id.display_name"/></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            
                                            <!-- Résumé -->
                                            <div class="mt-3 p-3 bg-light rounded">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <strong>Total places:</strong>
                                                    </div>
                                                    <div class="col-6 text-end">
                                                        <span class="badge bg-primary fs-6">
                                                            <t t-esc="len(orders)"/> place(s)
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </t>
                                        
                                        <t t-else="">
                                            <div class="alert alert-warning">
                                                <i class="fa fa-warning"></i>
                                                Aucune réservation trouvée.
                                            </div>
                                        </t>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <script>
                function showQRCode(paymentMethodId) {
                    // Masquer tous les QR codes
                    const allQRZones = document.querySelectorAll('.qr-zone');
                    allQRZones.forEach(zone => {
                        zone.style.display = 'none';
                    });
                    
                    // Afficher le QR code de la méthode sélectionnée
                    if (paymentMethodId) {
                        const selectedQRZone = document.getElementById('qr_zone_' + paymentMethodId);
                        if (selectedQRZone) {
                            selectedQRZone.style.display = 'block';
                        }
                    }
                }
            </script>
        </t>
    </template>
</odoo>