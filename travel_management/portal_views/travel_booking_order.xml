<?xml version='1.0' encoding='utf-8'?>
<odoo>
    <template id="travel_booking_order" name="Travel Booking Order">
        <t t-call="website.layout">
            <div class="container mt-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h3 class="mb-3 text-success">Réservation enregistrée</h3>
                        <p class="text-muted">Vos informations de réservation ont été enregistrées avec succès. Veuillez procéder au paiement.</p>
                        
                        <div class="row mt-4">
                            <!-- Colonne Gauche: Paiement -->
                            <div class="col-md-6">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0">Effectuer le paiement</h5>
                                    </div>
                                    <div class="card-body">
                                        <form method="post" enctype="multipart/form-data" action="/my/travel/order/pay">
                                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                            <input type="hidden" name="order_ids" t-att-value="','.join([str(o.id) for o in orders])"/>
                                            
                                            <!-- Sélection méthode de paiement -->
                                            <div class="mb-3">
                                                <label for="payment_method" class="form-label">Méthode de paiement</label>
                                                <select class="form-select" id="payment_method" name="payment_method_id" required="required" onchange="showQRCode(this.value)">
                                                    <option value="">Sélectionnez une méthode</option>
                                                    <t t-foreach="payment_methods" t-as="pm">
                                                        <option t-att-value="pm.id">
                                                            <t t-esc="pm.name"/>
                                                        </option>
                                                    </t>
                                                </select>
                                            </div>
                                            
                                            <!-- QR codes cachés pour chaque méthode -->
                                            <t t-foreach="payment_methods" t-as="pm">
                                                <div t-att-id="'qr_zone_' + str(pm.id)" class="mb-3 qr-zone" style="display: none;">
                                                    <label class="form-label">QR Code de paiement</label>
                                                    <div class="text-center p-3 border rounded">
                                                        <t t-if="pm.qr_code">
                                                            <!-- Utilise la route /web/image d'Odoo pour afficher l'image -->
                                                            <img t-att-src="'/web/image/payment.method/' + str(pm.id) + '/qr_code'" 
                                                                 alt="QR Code" class="img-fluid" style="max-width: 200px;"/>
                                                        </t>
                                                        <t t-else="">
                                                            <div class="text-muted">QR Code non disponible</div>
                                                        </t>
                                                        <p class="mt-2 text-muted small">Scannez ce QR code pour effectuer le paiement</p>
                                                    </div>
                                                </div>
                                            </t>
                                            
                                            <!-- Upload preuve de paiement -->
                                            <div class="mb-3">
                                                <label for="payment_proof" class="form-label">Preuve de paiement</label>
                                                <input type="file" class="form-control" id="payment_proof" name="payment_proof" accept="image/*" required="required"/>
                                                <div class="form-text">Téléchargez une capture d'écran de votre paiement</div>
                                            </div>
                                            
                                            <!-- Bouton validation -->
                                            <div class="d-grid">
                                                <button type="submit" class="btn btn-success btn-lg">
                                                    <i class="fa fa-check"></i> Valider le paiement
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Colonne Droite: Reçu de réservation -->
                            <div class="col-md-6">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0">
                                            <i class="fa fa-receipt"></i> Reçu de réservation
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <t t-if="orders">
                                            <!-- En-tête du reçu -->
                                            <div class="text-center mb-4">
                                                <h6 class="text-muted">REÇU DE RÉSERVATION</h6>
                                                <div class="text-muted small">
                                                    <t t-esc="datetime.datetime.now().strftime('%d/%m/%Y à %H:%M')"/>
                                                </div>
                                            </div>
                                            
                                            <!-- Informations voyage -->
                                            <div class="mb-3">
                                                <h6 class="border-bottom pb-2">Informations du voyage</h6>
                                                <t t-set="first_order" t-value="orders[0]"/>
                                                <div class="row mb-2">
                                                    <div class="col-4 text-muted">De:</div>
                                                    <div class="col-8">
                                                        <t t-esc="first_order.route_id.departure_point.name"/>
                                                    </div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-4 text-muted">Vers:</div>
                                                    <div class="col-8">
                                                        <t t-esc="first_order.route_id.arrival_point.name"/>
                                                    </div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-4 text-muted">Horaires:</div>
                                                    <div class="col-8">
                                                        <t t-esc="'%02d:%02d' % (int(first_order.route_id.hour_start), int((first_order.route_id.hour_start % 1) * 60))"/> - 
                                                        <t t-esc="'%02d:%02d' % (int(first_order.route_id.hour_end), int((first_order.route_id.hour_end % 1) * 60))"/>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Code de réservation -->
                                            <div class="mb-3">
                                                <h6 class="border-bottom pb-2">Code de réservation</h6>
                                                <div class="text-center p-3 bg-light rounded">
                                                    <div class="fw-bold fs-4 text-primary">
                                                        <t t-esc="first_order.code"/>
                                                    </div>
                                                    <div class="text-muted small">Gardez ce code pour vos références</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Numéros de places -->
                                            <div class="mb-3">
                                                <h6 class="border-bottom pb-2">Places réservées</h6>
                                                <div class="text-center p-3">
                                                    <t t-foreach="orders" t-as="order">
                                                        <span class="badge bg-success fs-6 me-2 mb-2 py-2 px-3">
                                                            Place <t t-esc="order.place"/>
                                                        </span>
                                                    </t>
                                                </div>
                                            </div>
                                            
                                            <!-- Résumé financier -->
                                            <div class="mb-3">
                                                <h6 class="border-bottom pb-2">Résumé</h6>
                                                <div class="row mb-2">
                                                    <div class="col-6 text-muted">Nombre de places:</div>
                                                    <div class="col-6 text-end">
                                                        <t t-esc="len(orders)"/>
                                                    </div>
                                                </div>
                                                <div class="row mb-2" t-if="first_order.route_id.price">
                                                    <div class="col-6 text-muted">Prix unitaire:</div>
                                                    <div class="col-6 text-end">
                                                        <t t-esc="first_order.route_id.price"/> <t t-esc="first_order.route_id.currency"/>
                                                    </div>
                                                </div>
                                                <hr/>
                                                <div class="row">
                                                    <div class="col-6 fw-bold">Total à payer:</div>
                                                    <div class="col-6 text-end fw-bold text-success fs-5">
                                                        <t t-set="total_amount" t-value="len(orders) * (first_order.route_id.price or 0)"/>
                                                        <t t-esc="total_amount"/> <t t-esc="first_order.route_id.currency"/>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                        </t>
                                        
                                        <t t-else="">
                                            <div class="alert alert-warning">
                                                <i class="fa fa-warning"></i>
                                                Aucune réservation trouvée.
                                            </div>
                                        </t>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <script>
                function showQRCode(paymentMethodId) {
                    // Masquer tous les QR codes
                    const allQRZones = document.querySelectorAll('.qr-zone');
                    allQRZones.forEach(zone => {
                        zone.style.display = 'none';
                    });
                    
                    // Afficher le QR code de la méthode sélectionnée
                    if (paymentMethodId) {
                        const selectedQRZone = document.getElementById('qr_zone_' + paymentMethodId);
                        if (selectedQRZone) {
                            selectedQRZone.style.display = 'block';
                        }
                    }
                }
            </script>
        </t>
    </template>
</odoo>