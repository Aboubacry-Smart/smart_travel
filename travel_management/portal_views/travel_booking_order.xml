<?xml version='1.0' encoding='utf-8'?>
<odoo>
    <template id="travel_booking_order" name="Travel Booking Order">
        <t t-call="website.layout">
            <style>
                /* Variables CSS cohérentes */
                :root {
                    --primary-color: #714B67;
                    --primary-light: #8b6580;
                    --primary-dark: #5a3c52;
                    --gray-50: #f9fafb;
                    --gray-100: #f3f4f6;
                    --gray-200: #e5e7eb;
                    --gray-300: #d1d5db;
                    --gray-600: #4b5563;
                    --gray-900: #111827;
                    --white: #ffffff;
                    --radius: 12px;
                    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                    --green: #10b981;
                    --green-light: #d1fae5;
                    --green-dark: #059669;
                    --blue: #3b82f6;
                    --blue-light: #dbeafe;
                    --orange: #f59e0b;
                    --orange-light: #fef3c7;
                }

                /* Reset et base */
                * {
                    box-sizing: border-box;
                }

                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    line-height: 1.6;
                    color: var(--gray-900);
                    background: var(--gray-50);
                }

                /* Container principal */
                .travel-order-container {
                    max-width: 80%;
                    margin: 40px auto;
                    padding: 0 20px;
                }

                /* Header de confirmation */
                .travel-success-header {
                    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-color) 100%);
                    padding: 30px;
                    text-align: center;
                    color: var(--white);
                    border-radius: var(--radius);
                    margin-bottom: 30px;
                    box-shadow: var(--shadow-lg);
                }

                .travel-success-header h1 {
                    margin: 0 0 10px 0;
                    font-size: 24px;
                    font-weight: 600;
                    letter-spacing: -0.02em;
                }

                .travel-success-header p {
                    margin: 0;
                    opacity: 0.9;
                    font-size: 16px;
                }

                /* Section principale */
                .travel-order-section {
                    background: var(--white);
                    border-radius: var(--radius);
                    box-shadow: var(--shadow-lg);
                    overflow: hidden;
                    margin-bottom: 30px;
                }

                /* Header de section */
                .section-header {
                    padding: 25px 30px;
                    border-bottom: 2px solid var(--gray-100);
                    background: var(--gray-50);
                }

                .section-header.payment {
                    border-bottom: none;
                }

                .section-header.receipt {
                    background: linear-gradient(135deg, var(--green) 0%, var(--green-dark) 100%);
                    color: var(--white);
                    border-bottom: none;
                }

                .section-header h3 {
                    margin: 0;
                    font-size: 20px;
                    font-weight: 600;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }

                .section-header i {
                    font-size: 18px;
                }

                .section-content {
                    padding: 30px;
                }

                /* Formulaire de paiement */
                .payment-form-group {
                    margin-bottom: 25px;
                }

                .payment-form-group label {
                    font-size: 12px;
                    font-weight: 500;
                    color: var(--gray-600);
                    text-transform: uppercase;
                    letter-spacing: 0.05em;
                    display: block;
                    margin-bottom: 8px;
                }

                .form-select, .form-control {
                    width: 100%;
                    padding: 14px 16px;
                    border: 2px solid var(--gray-200);
                    border-radius: var(--radius);
                    font-size: 16px;
                    background-color: var(--white);
                    color: var(--gray-900);
                    transition: all 0.2s ease;
                }

                .form-select:hover, .form-control:hover {
                    border-color: var(--gray-300);
                }

                .form-select:focus, .form-control:focus {
                    outline: none;
                    border-color: var(--primary-color);
                    box-shadow: 0 0 0 3px rgba(113, 75, 103, 0.1);
                }

                /* Zone QR Code */
                .qr-zone {
                    background: var(--gray-50);
                    border: 2px solid var(--gray-200);
                    border-radius: var(--radius);
                    padding: 25px;
                    text-align: center;
                    margin-bottom: 25px;
                }

                .qr-zone img {
                    max-width: 200px;
                    border-radius: var(--radius);
                    box-shadow: var(--shadow-md);
                }

                .qr-zone .qr-description {
                    margin-top: 15px;
                    color: var(--gray-600);
                    font-size: 14px;
                }

                /* Upload de fichier */
                .file-upload-zone {
                    border: 2px dashed var(--gray-300);
                    border-radius: var(--radius);
                    padding: 20px;
                    text-align: center;
                    background: var(--gray-50);
                    transition: all 0.2s ease;
                }

                .file-upload-zone:hover {
                    border-color: var(--primary-color);
                    background: var(--white);
                }

                .file-upload-zone input[type="file"] {
                    border: none;
                    background: transparent;
                    padding: 10px;
                }

                .file-help-text {
                    font-size: 12px;
                    color: var(--gray-500);
                    margin-top: 8px;
                }

                /* Bouton de paiement */
                .btn-payment {
                    width: 100%;
                    background: var(--green);
                    color: var(--white);
                    border: none;
                    padding: 18px 24px;
                    border-radius: var(--radius);
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    text-transform: uppercase;
                    letter-spacing: 0.05em;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 10px;
                }

                .btn-payment:hover {
                    background: var(--green-dark);
                    transform: translateY(-1px);
                    box-shadow: var(--shadow-md);
                }

                /* Message de succès */
                .success-message {
                    text-align: center;
                    padding: 40px 30px;
                }

                .success-icon {
                    font-size: 4rem;
                    color: var(--green);
                    margin-bottom: 20px;
                }

                .success-title {
                    color: var(--green-dark);
                    margin-bottom: 15px;
                    font-size: 24px;
                    font-weight: 600;
                }

                .success-description {
                    color: var(--gray-600);
                    margin-bottom: 30px;
                    line-height: 1.6;
                }

                .next-steps {
                    background: var(--blue-light);
                    border: 2px solid var(--blue);
                    border-radius: var(--radius);
                    padding: 20px;
                    text-align: left;
                }

                .next-steps strong {
                    color: var(--blue);
                }

                .next-steps ul {
                    margin: 10px 0 0 0;
                    padding-left: 20px;
                    color: var(--gray-700);
                }

                .next-steps li {
                    margin-bottom: 5px;
                }

                /* Section reçu */
                .receipt-header {
                    text-align: center;
                    padding-bottom: 20px;
                }

                .receipt-title {
                    color: var(--gray-600);
                    font-size: 14px;
                    font-weight: 600;
                    text-transform: uppercase;
                    letter-spacing: 0.1em;
                    margin-bottom: 5px;
                }

                .receipt-date {
                    color: var(--gray-500);
                    font-size: 12px;
                }

                /* Info voyage */
                .travel-info-section {
                    margin-bottom: 30px;
                }

                .travel-info-title {
                    color: var(--gray-900);
                    font-size: 14px;
                    font-weight: 600;
                    text-transform: uppercase;
                    letter-spacing: 0.05em;
                    margin-bottom: 15px;
                    padding-bottom: 10px;
                    border-bottom: 1px solid var(--gray-200);
                }

                .travel-info-row {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 12px;
                    align-items: center;
                }

                .travel-info-label {
                    color: var(--gray-600);
                    font-size: 14px;
                }

                .travel-info-value {
                    color: var(--gray-900);
                    font-weight: 500;
                    font-size: 14px;
                }

                /* Code de réservation */
                .reservation-code-section {
                    background: var(--gray-50);
                    border: 2px solid var(--primary-color);
                    border-radius: var(--radius);
                    padding: 25px;
                    text-align: center;
                    margin-bottom: 30px;
                }

                .reservation-code {
                    font-size: 32px;
                    font-weight: 700;
                    color: var(--primary-color);
                    letter-spacing: 0.1em;
                    margin-bottom: 8px;
                }

                .reservation-code-help {
                    color: var(--gray-600);
                    font-size: 12px;
                    margin-bottom: 20px;
                }

                .qr-code-container {
                    margin-top: 20px;
                }

                .qr-code-container img {
                    max-width: 150px;
                    border: 3px solid var(--white);
                    border-radius: var(--radius);
                    box-shadow: var(--shadow-md);
                }

                /* Places réservées */
                .seats-section {
                    text-align: center;
                    margin-bottom: 30px;
                }

                .seat-badge {
                    background: var(--primary-light);
                    color: var(--white);
                    padding: 12px 20px;
                    border-radius: 20px;
                    font-size: 14px;
                    font-weight: 600;
                    margin: 5px;
                    display: inline-block;
                }

                /* Résumé financier */
                .financial-summary {
                    background: var(--gray-50);
                    border-radius: var(--radius);
                    padding: 25px;
                }

                .summary-row {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 12px;
                    align-items: center;
                }

                .summary-label {
                    color: var(--gray-600);
                    font-size: 14px;
                }

                .summary-value {
                    color: var(--gray-900);
                    font-weight: 500;
                    font-size: 14px;
                }

                .summary-total {
                    border-top: 2px solid var(--gray-200);
                    padding-top: 15px;
                    margin-top: 15px;
                }

                .summary-total .summary-label {
                    font-weight: 600;
                    color: var(--gray-900);
                }

                .summary-total .summary-value {
                    font-weight: 700;
                    font-size: 18px;
                }

                /* Alerte */
                .travel-alert {
                    background: var(--orange-light);
                    border: 2px solid var(--orange);
                    border-radius: var(--radius);
                    padding: 16px 20px;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                }

                .travel-alert i {
                    color: var(--orange);
                    font-size: 18px;
                }

                .travel-alert-content {
                    color: #92400e;
                    font-size: 14px;
                }

                /* Utilitaires */
                .hide {
                    display: none !important;
                }

                /* Responsive */
                @media (max-width: 768px) {
                    .travel-order-container {
                        padding: 0 15px;
                        margin: 20px auto;
                    }

                    .section-content, .travel-success-header {
                        padding: 20px;
                    }

                    .reservation-code {
                        font-size: 24px;
                    }

                    .success-icon {
                        font-size: 3rem;
                    }
                }

                @media (max-width: 480px) {
                    .travel-order-container {
                        margin: 10px auto;
                        padding: 0 10px;
                    }

                    .section-content {
                        padding: 15px;
                    }

                    .travel-info-row, .summary-row {
                        flex-direction: column;
                        align-items: flex-start;
                        gap: 5px;
                    }
                }
            </style>
            
            <div class="travel-order-container">
                <!-- Header de confirmation -->
                <div class="travel-success-header">
                    <h1>Réservation enregistrée</h1>
                    <p>Vos informations de réservation ont été enregistrées avec succès. Veuillez procéder au paiement.</p>
                </div>

                <div class="row">
                    <!-- Section Paiement -->
                    <div class="col-lg-6">
                        <div class="travel-order-section">
                            <div id="payment_header" class="section-header payment">
                                <h3>
                                    <i class="fa fa-credit-card"></i>
                                    Effectuer le paiement
                                </h3>
                            </div>
                            <div class="section-content">
                                <form method="post" enctype="multipart/form-data" action="/my/travel/order/pay" id="payment-form">
                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                    <input type="hidden" name="order_ids" t-att-value="','.join([str(o.id) for o in orders])"/>
                                    
                                    <!-- Sélection méthode de paiement -->
                                    <div class="payment-form-group">
                                        <label for="payment_method">Méthode de paiement</label>
                                        <select class="form-select" id="payment_method" name="payment_method_id" required="required" onchange="showQRCode(this.value)">
                                            <option value="">Sélectionnez une méthode</option>
                                            <t t-foreach="payment_methods" t-as="pm">
                                                <option t-att-value="pm.id">
                                                    <t t-esc="pm.name"/>
                                                </option>
                                            </t>
                                        </select>
                                    </div>
                                    
                                    <!-- QR codes cachés pour chaque méthode -->
                                    <t t-foreach="payment_methods" t-as="pm">
                                        <div t-att-id="'qr_zone_' + str(pm.id)" class="qr-zone" style="display: none;">
                                            <t t-if="pm.qr_code">
                                                <img t-att-src="'/web/image/payment.method/' + str(pm.id) + '/qr_code'" 
                                                     alt="QR Code" class="img-fluid"/>
                                            </t>
                                            <t t-else="">
                                                <div class="text-muted">QR Code non disponible</div>
                                            </t>
                                            <div class="qr-description">Scannez ce QR code pour effectuer le paiement</div>
                                        </div>
                                    </t>
                                    
                                    <!-- Upload preuve de paiement -->
                                    <div class="payment-form-group">
                                        <label for="payment_proof">Preuve de paiement</label>
                                        <div class="file-upload-zone">
                                            <input type="file" class="form-control" id="payment_proof" name="payment_proof" accept="image/*" required="required"/>
                                            <div class="file-help-text">Téléchargez une capture d'écran de votre paiement</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Bouton validation -->
                                    <button type="submit" class="btn-payment" onclick="handlePaymentSubmit(event)">
                                        <i class="fa fa-check"></i>
                                        Valider le paiement
                                    </button>
                                </form>
                                
                                <!-- Message de succès (caché par défaut) -->
                                <div id="success-message" class="success-message" style="display: none;">
                                    <div class="success-icon">
                                        <i class="fa fa-check-circle"></i>
                                    </div>
                                    <h4 class="success-title">Paiement validé avec succès !</h4>
                                    <p class="success-description">
                                        Votre preuve de paiement a été envoyée pour vérification. 
                                        Vous recevrez une confirmation sous peu.
                                    </p>
                                    <div class="next-steps">
                                        <strong>Prochaines étapes :</strong>
                                        <ul>
                                            <li>Conservez votre reçu de réservation</li>
                                            <li>Présentez-vous 15 minutes avant le départ</li>
                                            <li>Ayez votre code de réservation à portée de main</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section Reçu -->
                    <div class="col-lg-6">
                        <div class="travel-order-section">
                            <!-- <div class="section-header receipt">
                                <h3>
                                    <i class="fa fa-receipt"></i>
                                    Reçu de réservation
                                </h3>
                            </div> -->
                            <div class="section-content">
                                <t t-if="orders">
                                    <!-- En-tête du reçu -->
                                    <div class="receipt-header">
                                        <div class="receipt-title">Reçu de réservation</div>
                                        <div class="receipt-date">
                                            <t t-esc="datetime.datetime.now().strftime('%d/%m/%Y à %H:%M')"/>
                                        </div>
                                    </div>
                                    
                                    <!-- Informations voyage -->
                                    <div class="travel-info-section">
                                        <div class="travel-info-title">Informations du voyage</div>
                                        <t t-set="first_order" t-value="orders[0]"/>
                                        <div class="travel-info-row">
                                            <span class="travel-info-label">De :</span>
                                            <span class="travel-info-value">
                                                <t t-esc="first_order.route_id.departure_point.name"/>
                                            </span>
                                        </div>
                                        <div class="travel-info-row">
                                            <span class="travel-info-label">Vers :</span>
                                            <span class="travel-info-value">
                                                <t t-esc="first_order.route_id.arrival_point.name"/>
                                            </span>
                                        </div>
                                        <div class="travel-info-row">
                                            <span class="travel-info-label">Horaires :</span>
                                            <span class="travel-info-value">
                                                <t t-set="line" t-value="first_order.route_line_id or (first_order.route_id.route_line_ids and first_order.route_id.route_line_ids[0])"/>
                                                <t t-if="line">
                                                    <t t-esc="'%02d:%02d' % (int(line.hour_start), int((line.hour_start % 1) * 60))"/> -
                                                    <t t-esc="'%02d:%02d' % (int(line.hour_end), int((line.hour_end % 1) * 60))"/>
                                                </t>
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <!-- Code de réservation -->
                                    <div class="reservation-code-section">
                                        <div class="reservation-code">
                                            <t t-esc="first_order.code"/>
                                        </div>
                                        <div class="reservation-code-help">Gardez ce code pour vos références</div>
                                        
                                        <!-- QR Code de la réservation -->
                                        <div class="qr-code-container">
                                            <t t-if="first_order.qr_code">
                                                <img t-att-src="'data:image/png;base64,' + first_order.qr_code.decode('utf-8')" 
                                                     alt="QR Code Réservation" 
                                                     class="img-fluid"/>
                                            </t>
                                            <t t-else="">
                                                <div class="text-muted small">QR Code non disponible</div>
                                            </t>
                                        </div>
                                    </div>
                                    
                                    <!-- Places réservées -->
                                    <div class="travel-info-section seats-section">
                                        <div class="travel-info-title">Places réservées</div>
                                        <div>
                                            <t t-foreach="orders" t-as="order">
                                                <span class="seat-badge">
                                                    Place <t t-esc="order.place"/>
                                                </span>
                                            </t>
                                        </div>
                                    </div>
                                    
                                    <!-- Résumé financier -->
                                    <div class="financial-summary">
                                        <div class="summary-row">
                                            <span class="summary-label">Nombre de places :</span>
                                            <span class="summary-value">
                                                <t t-esc="len(orders)"/>
                                            </span>
                                        </div>
                                        <div class="summary-row" t-if="first_order.route_id.price">
                                            <span class="summary-label">Prix unitaire :</span>
                                            <span class="summary-value">
                                                <t t-esc="first_order.route_id.price"/> <t t-esc="first_order.route_id.currency"/>
                                            </span>
                                        </div>
                                        <div class="summary-row summary-total">
                                            <span class="summary-label">Total à payer :</span>
                                            <span class="summary-value">
                                                <t t-set="total_amount" t-value="len(orders) * (first_order.route_id.price or 0)"/>
                                                <t t-esc="total_amount"/> <t t-esc="first_order.route_id.currency"/>
                                            </span>
                                        </div>
                                    </div>
                                    
                                </t>
                                
                                <t t-else="">
                                    <div class="travel-alert">
                                        <i class="fa fa-exclamation-triangle"></i>
                                        <div class="travel-alert-content">
                                            Aucune réservation trouvée.
                                        </div>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        
            <script><![CDATA[
                // Print optimization
                document.addEventListener('DOMContentLoaded', function() {
                    const beforePrint = () => {
                        console.log('Functionality to run before printing.');
                    };
                    
                    const afterPrint = () => {
                        console.log('Functionality to run after printing');
                    };
                    
                    if (window.matchMedia) {
                        const mediaQueryList = window.matchMedia('print');
                        mediaQueryList.addListener((mql) => {
                            if (mql.matches) {
                                beforePrint();
                            } else {
                                afterPrint();
                            }
                        });
                    }
                    
                    window.onbeforeprint = beforePrint;
                    window.onafterprint = afterPrint;
                });
                
                function showQRCode(paymentMethodId) {
                    // Masquer tous les QR codes
                    var allQRZones = document.querySelectorAll('.qr-zone');
                    allQRZones.forEach(function(zone) {
                        zone.style.display = 'none';
                    });
                    
                    // Afficher le QR code de la méthode sélectionnée
                    if (paymentMethodId) {
                        var selectedQRZone = document.getElementById('qr_zone_' + paymentMethodId);
                        if (selectedQRZone) {
                            selectedQRZone.style.display = 'block';
                        }
                    }
                }
                
                function handlePaymentSubmit(event) {
                    // Vérifier que tous les champs requis sont remplis
                    var form = event.target.form;
                    var paymentMethod = form.querySelector('#payment_method').value;
                    var paymentProof = form.querySelector('#payment_proof').files.length;
                    
                    if (!paymentMethod) {
                        alert('Veuillez sélectionner une méthode de paiement');
                        event.preventDefault();
                        return false;
                    }
                    
                    if (!paymentProof) {
                        alert('Veuillez télécharger une preuve de paiement');
                        event.preventDefault();
                        return false;
                    }
                    
                    // Désactiver le bouton pour éviter les doubles envois
                    event.target.disabled = true;
                    event.target.textContent = 'Envoi en cours...';
                    // Forcer la soumission du formulaire pour éviter qu'un autre script ne l'empêche
                    event.preventDefault();
                    form.submit();
                }
                
                function printReceipt() {
                    window.print();
                }
            ]]></script>
        </t>
    </template>
</odoo>