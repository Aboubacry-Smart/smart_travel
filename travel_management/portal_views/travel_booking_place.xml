<?xml version='1.0' encoding='utf-8'?>
<odoo>
    <template id="travel_booking_place" name="Travel Booking Place">
        <t t-call="website.layout">
            <style>
                /* Variables CSS cohérentes */
                :root {
                    --primary-color: #714B67;
                    --primary-light: #8b6580;
                    --primary-dark: #5a3c52;
                    --gray-50: #f9fafb;
                    --gray-100: #f3f4f6;
                    --gray-200: #e5e7eb;
                    --gray-300: #d1d5db;
                    --gray-600: #4b5563;
                    --gray-900: #111827;
                    --white: #ffffff;
                    --radius: 12px;
                    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                    --green: #10b981;
                    --green-dark: #059669;
                    --orange: #f59e0b;
                    --orange-dark: #d97706;
                    --red: #ef4444;
                    --red-dark: #dc2626;
                }

                /* Reset et base */
                * {
                    box-sizing: border-box;
                }

                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    line-height: 1.6;
                    color: var(--gray-900);
                    background: var(--gray-50);
                }

                /* Container principal */
                .travel-main-container {
                    max-width: 80%;
                    margin: 40px auto;
                    padding: 0 20px;
                }

                /* Header de la page */
                .travel-page-header {
                    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
                    padding: 30px;
                    text-align: center;
                    color: var(--white);
                    border-radius: var(--radius);
                    margin-bottom: 30px;
                    box-shadow: var(--shadow-lg);
                }

                .travel-page-header h1 {
                    margin: 0 0 8px 0;
                    font-size: 24px;
                    font-weight: 600;
                    letter-spacing: -0.02em;
                }

                .travel-page-header p {
                    margin: 0;
                    opacity: 0.9;
                    font-size: 16px;
                }

                /* Section du bus */
                .bus-section {
                    background: var(--white);
                    border-radius: var(--radius);
                    padding: 40px;
                    box-shadow: var(--shadow-lg);
                    margin-bottom: 30px;
                }

                .bus-header {
                    text-align: center;
                    margin-bottom: 40px;
                    padding-bottom: 20px;
                    border-bottom: 2px solid var(--gray-100);
                }

                .bus-header h2 {
                    color: var(--primary-color);
                    margin: 0 0 10px 0;
                    font-size: 20px;
                    font-weight: 600;
                }

                .bus-header p {
                    color: var(--gray-600);
                    margin: 0;
                    font-size: 14px;
                }

                /* Layout des sièges */
                .seat-layout {
                    display: flex;
                    flex-direction: column;
                    gap: 15px;
                    max-width: 400px;
                    margin: 0 auto;
                }

                .seat-row {
                    display: flex;
                    justify-content: center;
                    gap: 12px;
                    align-items: center;
                }

                /* Styles des sièges */
                .seat {
                    width: 50px;
                    height: 50px;
                    border: 2px solid var(--gray-200);
                    border-radius: 10px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: 600;
                    font-size: 14px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    position: relative;
                    background: var(--white);
                }

                .seat.driver {
                    background: linear-gradient(135deg, var(--gray-300), var(--gray-200));
                    color: var(--gray-600);
                    cursor: not-allowed;
                    width: 110px;
                    border-color: var(--gray-300);
                    font-size: 12px;
                }

                .seat.available {
                    background: var(--green);
                    color: var(--white);
                    border-color: var(--green);
                }

                .seat.available:hover {
                    background: var(--green-dark);
                    border-color: var(--green-dark);
                    transform: translateY(-2px);
                    box-shadow: var(--shadow-md);
                }

                .seat.selected {
                    background: var(--orange);
                    color: var(--white);
                    border-color: var(--orange);
                    transform: scale(1.05);
                    box-shadow: var(--shadow-md);
                    animation: pulse 2s infinite;
                }

                .seat.in_process {
                    background: var(--primary-color);
                    color: var(--white);
                    border-color: var(--primary-color);
                    cursor: not-allowed;
                    animation: pulse 2s infinite;
                }

                .seat.booked {
                    background: var(--red);
                    color: var(--white);
                    border-color: var(--red);
                    cursor: not-allowed;
                }

                @keyframes pulse {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.8; }
                }

                /* Allée centrale */
                .aisle {
                    width: 40px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: var(--gray-300);
                    font-size: 24px;
                    user-select: none;
                }

                /* Légende */
                .legend {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                    gap: 15px;
                    margin-top: 40px;
                    padding: 25px;
                    background: var(--gray-50);
                    border-radius: var(--radius);
                }

                .legend-item {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    font-size: 14px;
                    color: var(--gray-700);
                }

                .legend-color {
                    width: 24px;
                    height: 24px;
                    border-radius: 6px;
                    border: 1px solid var(--gray-300);
                    flex-shrink: 0;
                }

                .legend-color.driver { background: linear-gradient(135deg, var(--gray-300), var(--gray-200)); }
                .legend-color.available { background: var(--green); }
                .legend-color.selected { background: var(--orange); }
                .legend-color.in_process { background: var(--primary-color); }
                .legend-color.booked { background: var(--red); }

                /* Section de réservation */
                .booking-section {
                    background: var(--white);
                    border-radius: var(--radius);
                    box-shadow: var(--shadow-lg);
                    overflow: hidden;
                }

                .booking-header {
                    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
                    padding: 25px;
                    text-align: center;
                    color: var(--white);
                }

                .booking-header h3 {
                    margin: 0 0 8px 0;
                    font-size: 20px;
                    font-weight: 600;
                }

                .booking-header p {
                    margin: 0;
                    opacity: 0.9;
                    font-size: 14px;
                }

                .booking-content {
                    padding: 30px;
                }

                /* Section sièges sélectionnés */
                .selected-seats-section {
                    background: var(--gray-50);
                    border: 1px solid var(--gray-200);
                    border-radius: var(--radius);
                    padding: 20px;
                    margin-bottom: 25px;
                }

                .selected-seats-header {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    margin-bottom: 15px;
                }

                .selected-seats-title {
                    font-weight: 600;
                    color: var(--gray-900);
                    font-size: 14px;
                    text-transform: uppercase;
                    letter-spacing: 0.05em;
                }

                .seat-count-badge {
                    background: var(--primary-color);
                    color: var(--white);
                    padding: 4px 10px;
                    border-radius: 12px;
                    font-size: 12px;
                    font-weight: 600;
                }

                .selected-seat-item {
                    background: var(--orange);
                    color: var(--white);
                    padding: 6px 12px;
                    border-radius: 20px;
                    font-size: 12px;
                    font-weight: 500;
                    margin: 4px;
                    display: inline-block;
                }

                .empty-selection {
                    color: var(--gray-500);
                    font-style: italic;
                    font-size: 14px;
                }

                /* Section total */
                .total-section {
                    background: #ecfdf5;
                    border: 2px solid var(--green);
                    border-radius: var(--radius);
                    padding: 25px;
                    text-align: center;
                    margin-bottom: 25px;
                }

                .total-amount {
                    font-size: 32px;
                    font-weight: 700;
                    color: var(--green-dark);
                    margin: 0;
                    line-height: 1;
                }

                .total-label {
                    color: var(--green-dark);
                    font-size: 14px;
                    font-weight: 500;
                    margin-top: 5px;
                }

                /* Alertes */
                .travel-alert {
                    padding: 16px 20px;
                    border-radius: var(--radius);
                    font-size: 14px;
                    border-left: 4px solid;
                    margin-bottom: 20px;
                    display: none;
                }

                .travel-alert.show {
                    display: block;
                }

                .travel-alert-danger {
                    background: #fee2e2;
                    border-left-color: var(--red);
                    color: var(--red-dark);
                }

                /* Formulaires passagers */
                .passenger-form {
                    background: var(--gray-50);
                    border: 1px solid var(--gray-200);
                    border-radius: var(--radius);
                    padding: 25px;
                    margin-bottom: 20px;
                }

                .passenger-form h6 {
                    color: var(--gray-900);
                    margin: 0 0 20px 0;
                    font-weight: 600;
                    font-size: 16px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }

                .seat-badge {
                    background: var(--orange);
                    color: var(--white);
                    padding: 4px 10px;
                    border-radius: 12px;
                    font-size: 12px;
                    font-weight: 500;
                }

                /* Formulaire inputs */
                .form-control, .form-select {
                    width: 100%;
                    padding: 14px 16px;
                    border: 2px solid var(--gray-200);
                    border-radius: var(--radius);
                    font-size: 16px;
                    background-color: var(--white);
                    color: var(--gray-900);
                    transition: all 0.2s ease;
                    margin-top: 6px;
                }

                .form-control:hover, .form-select:hover {
                    border-color: var(--gray-300);
                }

                .form-control:focus, .form-select:focus {
                    outline: none;
                    border-color: var(--primary-color);
                    box-shadow: 0 0 0 3px rgba(113, 75, 103, 0.1);
                }

                .form-control::placeholder {
                    color: var(--gray-400);
                }

                label {
                    font-size: 12px;
                    font-weight: 500;
                    color: var(--gray-600);
                    text-transform: uppercase;
                    letter-spacing: 0.05em;
                    display: block;
                }

                /* Section contact */
                .contact-section {
                    background: #fef3c7;
                    border: 2px solid var(--orange);
                    border-radius: var(--radius);
                    padding: 25px;
                    margin-bottom: 25px;
                }

                /* Section date de voyage: centrée + marge bas */
                .date-section {
                    margin-bottom: 25px;
                    text-align: center;
                }
                .date-section .row {
                    justify-content: center;
                }

                .contact-section h6 {
                    color: #92400e;
                    margin: 0 0 20px 0;
                    font-weight: 600;
                    font-size: 14px;
                    text-transform: uppercase;
                    letter-spacing: 0.05em;
                }

                /* Bouton de confirmation */
                .btn-confirm {
                    width: 100%;
                    background: var(--primary-color);
                    color: var(--white);
                    border: none;
                    padding: 18px 24px;
                    border-radius: var(--radius);
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    text-transform: uppercase;
                    letter-spacing: 0.05em;
                }

                .btn-confirm:hover:not(:disabled) {
                    background: var(--primary-dark);
                    transform: translateY(-1px);
                    box-shadow: var(--shadow-md);
                }

                .btn-confirm:disabled {
                    background: var(--gray-300);
                    color: var(--gray-500);
                    cursor: not-allowed;
                    transform: none;
                    box-shadow: none;
                }

                /* Utilitaires */
                .hide {
                    display: none !important;
                }

                /* Responsive Design */
                @media (max-width: 768px) {
                    .travel-main-container {
                        padding: 0 15px;
                        margin: 20px auto;
                    }

                    .bus-section, .booking-content {
                        padding: 20px;
                    }

                    .travel-page-header {
                        padding: 20px;
                    }

                    .seat {
                        width: 40px;
                        height: 40px;
                        font-size: 12px;
                    }

                    .seat.driver {
                        width: 90px;
                        font-size: 10px;
                    }

                    .legend {
                        grid-template-columns: 1fr 1fr;
                        gap: 10px;
                        padding: 20px;
                    }

                    .total-amount {
                        font-size: 24px;
                    }
                }

                @media (max-width: 480px) {
                    .travel-main-container {
                        margin: 10px auto;
                        padding: 0 10px;
                    }

                    .bus-section, .booking-content, .contact-section, .passenger-form {
                        padding: 15px;
                    }

                    .seat-layout {
                        gap: 10px;
                    }

                    .seat-row {
                        gap: 8px;
                    }

                    .legend {
                        grid-template-columns: 1fr;
                    }
                }
            </style>
            
            <div class="travel-main-container">
                <!-- Header de la page -->
                <div class="travel-page-header">
                    <h1>Sélection des sièges</h1>
                    <p>Choisissez vos places pour votre voyage</p>
                </div>

                <div class="row">
                    <!-- Section du plan du bus -->
                    <div class="col-lg-6">
                        <div class="bus-section">
                            <div class="bus-header">
                                <h2><t t-esc="route_name"/></h2>
                                <p> 
                                    <t t-esc="departure_point"/> → <t t-esc="arrival_point"/> 
                                    | Départ: <t t-esc="'{0:02.0f}:{1:02.0f}'.format(*divmod(hour_start * 60, 60))"/> 
                                    | Arrivée: <t t-esc="'{0:02.0f}:{1:02.0f}'.format(*divmod(hour_end * 60, 60))"/> 
                                </p> 
                            </div>

                            <div class="seat-layout">
                                <!-- Ligne 1: Chauffeur + 2 sièges passagers -->
                                <div class="seat-row">
                                    <div class="seat driver" data-seat="D1">Chauffeur</div>
                                    <div class="aisle">┋</div>
                                    <div class="seat available" data-seat="1" data-group="1">1</div>
                                    <div class="seat booked" data-seat="2" data-group="1" data-gender="male">2</div>
                                </div>

                                <!-- Ligne 2: 4 sièges passagers -->
                                <div class="seat-row">
                                    <div class="seat available" data-seat="3" data-group="2">3</div>
                                    <div class="seat available" data-seat="4" data-group="2">4</div>
                                    <div class="aisle">┋</div>
                                    <div class="seat available" data-seat="5" data-group="3">5</div>
                                    <div class="seat available" data-seat="6" data-group="3">6</div>
                                </div>

                                <!-- Ligne 3: 4 sièges passagers -->
                                <div class="seat-row">
                                    <div class="seat available" data-seat="7" data-group="4">7</div>
                                    <div class="seat available" data-seat="8" data-group="4">8</div>
                                    <div class="aisle">┋</div>
                                    <div class="seat booked" data-seat="9" data-group="5" data-gender="female">9</div>
                                    <div class="seat available" data-seat="10" data-group="5">10</div>
                                </div>

                                <!-- Ligne 4: 4 sièges passagers -->
                                <div class="seat-row">
                                    <div class="seat available" data-seat="11" data-group="6">11</div>
                                    <div class="seat available" data-seat="12" data-group="6">12</div>
                                    <div class="aisle">┋</div>
                                    <div class="seat in_process" data-seat="13" data-group="7">13</div>
                                    <div class="seat available" data-seat="14" data-group="7">14</div>
                                </div>

                                <!-- Ligne 5: 4 sièges passagers -->
                                <div class="seat-row">
                                    <div class="seat available" data-seat="15" data-group="8">15</div>
                                    <div class="seat available" data-seat="16" data-group="8">16</div>
                                    <div class="aisle">┋</div>
                                    <div class="seat available" data-seat="17" data-group="9">17</div>
                                    <div class="seat booked" data-seat="18" data-group="9" data-gender="male">18</div>
                                </div>
                            </div>

                            <!-- Légende -->
                            <div class="legend">
                                <div class="legend-item">
                                    <div class="legend-color available"></div>
                                    <span>Disponible</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color selected"></div>
                                    <span>Sélectionné</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color in_process"></div>
                                    <span>En cours</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color booked"></div>
                                    <span>Réservé</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section formulaire de réservation -->
                    <div class="col-lg-6">
                        <div class="booking-section">
                            <div class="booking-header">
                                <h3>Informations de Réservation</h3>
                                <p><t t-esc="departure_point"/> → <t t-esc="arrival_point"/> | Prix: <t t-esc="price"/> <t t-esc="currency"/></p>
                            </div>

                            <div class="booking-content">
                                <!-- Section des sièges sélectionnés -->
                                <div class="selected-seats-section">
                                    <div class="selected-seats-header">
                                        <span class="selected-seats-title">Sièges sélectionnés</span>
                                        <span class="seat-count-badge" id="seat-count">0</span>
                                    </div>
                                    <div id="selected-seats-list">
                                        <div class="empty-selection">Aucun siège sélectionné</div>
                                    </div>
                                </div>

                                <!-- Section du total -->
                                <div class="total-section">
                                    <p class="total-amount" id="total-amount">0 <t t-esc="currency"/></p>
                                    <div class="total-label">Total à payer</div>
                                </div>

                                <!-- Alerte de validation de genre -->
                                <div id="gender-validation-alert" class="travel-alert travel-alert-danger">
                                    <span id="gender-validation-message"></span>
                                </div>

                                <!-- Formulaire -->
                                <form action="/my/travel/order" method="post" id="booking-form">
                                    <div id="passenger-forms-container">
                                        <!-- Formulaires passagers générés dynamiquement -->
                                    </div>

                                    <div class="mb-3 px-4">
                                        <div class="row">
                                            <label>DATE DE VOYAGE *</label>
                                            <div class="col-md-12">
                                                <input type="date" class="form-control" name="date" placeholder="Date de voyage" required="required"/>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Champs cachés -->
                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                    <input type="hidden" id="selected_seats_input" name="selected_seats" value=""/>
                                    <input type="hidden" id="total_amount_input" name="total_amount" value="0"/>
                                    <input type="hidden" name="route_id" t-att-value="route_id"/>
                                    <input type="hidden" name="price_per_seat" t-att-value="price"/>

                                    <!-- Bouton de confirmation -->
                                    <button type="submit" class="btn-confirm" id="confirm-btn" disabled="disabled">
                                        Confirmer la Réservation
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Valeurs injectées via QWeb pour usage JS -->
            <span id="qweb-price" style="display:none"><t t-esc="price"/></span>
            <span id="qweb-currency" style="display:none"><t t-esc="currency"/></span>

            <script>
                <![CDATA[
            document.addEventListener('DOMContentLoaded', function() {
                // Récupération des valeurs rendues par QWeb
                var PRICE_PER_SEAT = parseFloat((document.getElementById('qweb-price') || {}).textContent || '');
                var CURRENCY = ((document.getElementById('qweb-currency') || {}).textContent || '').trim();
                // Valeurs par défaut si absence
                if (isNaN(PRICE_PER_SEAT)) { PRICE_PER_SEAT = 50; }
                if (!CURRENCY) { CURRENCY = 'MRU'; }
                // Override depuis les paramètres d'URL
                try {
                    var params = new URLSearchParams(window.location.search);
                    var p = parseFloat(params.get('price'));
                    if (!isNaN(p)) { PRICE_PER_SEAT = p; }
                    var curr = params.get('currency') || params.get('devise');
                    if (curr) { CURRENCY = curr; }
                } catch (e) { /* ignore */ }
                
                // Définition des groupes de sièges adjacents
                var SEAT_GROUPS = {
                    1: [1, 2],
                    2: [3, 4],
                    3: [5, 6],
                    4: [7, 8],
                    5: [9, 10],
                    6: [11, 12],
                    7: [13, 14],
                    8: [15, 16],
                    9: [17, 18]
                };

                // Gestion des clics sur les sièges
                document.querySelectorAll('.seat.available').forEach(function(seat) {
                    seat.addEventListener('click', function() {
                        if (this.classList.contains('selected')) {
                            this.classList.remove('selected');
                            this.classList.add('available');
                        } else {
                            this.classList.remove('available');
                            this.classList.add('selected');
                        }
                        updateBookingDetails();
                    });
                });

                // Obtenir le groupe d'un siège
                function getSeatGroup(seatNumber) {
                    seatNumber = parseInt(seatNumber);
                    for (var groupId in SEAT_GROUPS) {
                        if (SEAT_GROUPS[groupId].includes(seatNumber)) {
                            return SEAT_GROUPS[groupId];
                        }
                    }
                    return null;
                }

                // Obtenir le genre d'un siège déjà réservé
                function getBookedGenderForSeat(seatNumber) {
                    var bookedSeat = document.querySelector('.seat.booked[data-seat="' + seatNumber + '"]');
                    return bookedSeat ? bookedSeat.getAttribute('data-gender') : null;
                }

                // Obtenir le genre sélectionné dans le formulaire
                function getFormGenderForSeat(seatNumber) {
                    var genderSelect = document.querySelector('select[name="passenger_' + seatNumber + '_gender"]');
                    return genderSelect ? genderSelect.value : null;
                }

                // Validation des contraintes de genre
                function validateGenderConstraints() {
                    var selectedSeats = document.querySelectorAll('.seat.selected');
                    var alertDiv = document.getElementById('gender-validation-alert');
                    var messageSpan = document.getElementById('gender-validation-message');
                    
                    if (selectedSeats.length === 0) {
                        alertDiv.classList.remove('show');
                        enableConfirmButton();
                        return true;
                    }

                    // Vérifier d'abord que tous les genres sont sélectionnés
                    var allGendersSelected = true;
                    var missingGenders = [];
                    
                    selectedSeats.forEach(function(seat) {
                        var seatNumber = seat.getAttribute('data-seat');
                        var gender = getFormGenderForSeat(seatNumber);
                        
                        if (!gender) {
                            allGendersSelected = false;
                            missingGenders.push(seatNumber);
                        }
                    });

                    if (!allGendersSelected) {
                        showGenderValidationError('Veuillez sélectionner le genre pour les sièges: ' + missingGenders.join(', '));
                        return false;
                    }

                    // Vérifier conflits entre sièges sélectionnés d'un même groupe
                    for (var i = 0; i < selectedSeats.length; i++) {
                        var seatNumberA = selectedSeats[i].getAttribute('data-seat');
                        var groupA = getSeatGroup(seatNumberA);
                        if (!groupA) continue;

                        for (var j = 0; j < groupA.length; j++) {
                            var seatNumberB = String(groupA[j]);
                            if (seatNumberB === seatNumberA) continue;
                            var bSelected = document.querySelector('.seat.selected[data-seat="' + seatNumberB + '"]');
                            if (bSelected) {
                                var genderA = getFormGenderForSeat(seatNumberA);
                                var genderB = getFormGenderForSeat(seatNumberB);
                                if (genderA && genderB && genderA !== genderB) {
                                    showGenderValidationError('Les sièges ' + seatNumberA + ' et ' + seatNumberB + ' ne peuvent pas être adjacents avec des genres opposés');
                                    return false;
                                }
                            }
                        }
                    }

                    // Vérifier les conflits avec les sièges déjà réservés
                    for (var i = 0; i < selectedSeats.length; i++) {
                        var seatNumber = selectedSeats[i].getAttribute('data-seat');
                        var group = getSeatGroup(seatNumber);
                        
                        if (!group) continue;

                        // Vérifier les sièges adjacents déjà réservés
                        for (var j = 0; j < group.length; j++) {
                            var adjacentSeat = group[j];
                            
                            if (adjacentSeat != seatNumber) {
                                var adjacentGender = getBookedGenderForSeat(adjacentSeat);
                                
                                if (adjacentGender) {
                                    var selectedGender = getFormGenderForSeat(seatNumber);
                                    
                                    if (selectedGender && selectedGender !== adjacentGender) {
                                        showGenderValidationError('Le siège ' + seatNumber + ' (' + (selectedGender === 'male' ? 'Homme' : 'Femme') + 
                                                                ') ne peut pas être à côté du siège ' + adjacentSeat + ' (' + (adjacentGender === 'male' ? 'Homme' : 'Femme') + ')');
                                        return false;
                                    }
                                }
                            }
                        }
                    }

                    // Si tout est OK
                    alertDiv.style.display = 'none';
                    enableConfirmButton();
                    return true;
                }

                function showGenderValidationError(message) {
                    var alertDiv = document.getElementById('gender-validation-alert');
                    var messageSpan = document.getElementById('gender-validation-message');
                    var confirmBtn = document.getElementById('confirm-btn');
                    
                    if (alertDiv && messageSpan && confirmBtn) {
                        messageSpan.textContent = message;
                        alertDiv.style.display = 'block';
                        confirmBtn.disabled = true;
                    }
                }

                function enableConfirmButton() {
                    var confirmBtn = document.getElementById('confirm-btn');
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                    }
                }

                function updateBookingDetails() {
                    var selectedSeats = document.querySelectorAll('.seat.selected');
                    var seatCount = selectedSeats.length;
                    var totalAmount = seatCount * PRICE_PER_SEAT;

                    // Mise à jour du compteur
                    document.getElementById('seat-count').textContent = seatCount;

                    // Mise à jour de la liste des sièges
                    var seatsList = document.getElementById('selected-seats-list');
                    if (seatCount === 0) {
                        seatsList.innerHTML = '<div style="color: #6b7280; font-style: italic;">Aucun siège sélectionné</div>';
                    } else {
                        var seatsHTML = '';
                        var selectedSeatNumbers = [];

                        selectedSeats.forEach(function(seat) {
                            var seatNumber = seat.getAttribute('data-seat');
                            selectedSeatNumbers.push(seatNumber);
                            seatsHTML += '<div class="selected-seat-item">Siège ' + seatNumber + '</div>';
                        });

                        seatsList.innerHTML = seatsHTML;
                        document.getElementById('selected_seats_input').value = selectedSeatNumbers.join(',');
                    }

                    // Mise à jour du montant total
                    document.getElementById('total-amount').textContent = totalAmount + ' ' + CURRENCY;
                    document.getElementById('total_amount_input').value = totalAmount;

                    // Mise à jour des formulaires passagers
                    updatePassengerForms(selectedSeats);

                    // Affichage de la section date de voyage (rendu optionnel)
                    var dateSection = document.getElementById('date-section');
                    var confirmBtn = document.getElementById('confirm-btn');
                    var dateInput = document.querySelector('input[name="date"]');

                    if (seatCount > 0) {
                        if (dateSection) {
                            dateSection.classList.remove('hide');
                            dateSection.style.display = 'block';
                        }
                        if (dateInput) dateInput.required = true;
                        validateGenderConstraints();
                    } else {
                        if (dateSection) {
                            dateSection.classList.add('hide');
                            dateSection.style.display = 'none';
                        }
                        if (dateInput) dateInput.required = false;
                        if (confirmBtn) {
                            confirmBtn.disabled = true;
                            confirmBtn.textContent = 'Confirmer votre réservation';
                        }
                    }
                }


                function updatePassengerForms(selectedSeats) {
                    var container = document.getElementById('passenger-forms-container');
                    container.innerHTML = '';

                    selectedSeats.forEach(function(seat, index) {
                        var seatNumber = seat.getAttribute('data-seat');
                        var formHTML = 
                            '<div class="passenger-form">' +
                                '<h6 style="color: #374151; margin-bottom: 15px; font-weight: bold;">' +
                                    'Passager ' + (index + 1) + ' ' +
                                    '<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">Siège ' + seatNumber + '</span>' +
                                '</h6>' +
                                '<div class="row">' +
                                    '<div class="col-md-6">' +
                                        '<label>Nom complet *</label>' +
                                        '<input type="text" class="form-control" name="passenger_' + seatNumber + '_name" placeholder="Prénom et nom" required="required"/>' +
                                    '</div>' +
                                    '<div class="col-md-3">' +
                                        '<label>Téléphone *</label>' +
                                        '<input type="tel" class="form-control" name="passenger_' + seatNumber + '_phone" placeholder="0XXXXXXXX" required="required"/>' +
                                    '</div>' +
                                    '<div class="col-md-3">' +
                                        '<label>Sexe *</label>' +
                                        '<select class="form-select gender-select" name="passenger_' + seatNumber + '_gender" data-seat="' + seatNumber + '" required="required" onchange="validateGenderConstraints()">' +
                                            '<option value="" disabled selected>Choisir</option>' +
                                            '<option value="male">Homme</option>' +
                                            '<option value="female">Femme</option>' +
                                        '</select>' +
                                    '</div>' +
                                '</div>' +
                            '</div>';
                        
                        container.innerHTML += formHTML;
                    });
                }

                // Validation avant soumission du formulaire
                document.getElementById('booking-form').addEventListener('submit', function(e) {
                    if (!validateGenderConstraints()) {
                        e.preventDefault();
                        alert('Veuillez corriger les erreurs de validation avant de soumettre.');
                    }
                });

                // Initialisation
                updateBookingDetails();
                
                // Exposer la fonction globalement pour les événements inline
                window.validateGenderConstraints = validateGenderConstraints;
            });
                ]]>
            </script> 
        </t>
    </template>
</odoo>